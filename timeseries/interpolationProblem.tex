\documentclass{article}
\usepackage{graphicx}
\usepackage{amsmath}
\usepackage{mathrsfs}
\usepackage[margin=1in]{geometry} % Reduce margins to use more of the page
\begin{document}

\subsection{Problem Statement}
I aim to model a seasonal leaf coverage curve for multiple trees across multiple phenological years.
Leaf coverage is a continuous variable ranging from 0 to 100, where 0 means no leaves and 100 means full leaf coverage.
Phenological years are defined as a full cycle of leaf coverage, which may not align with calendar years.
For example, some trees have bimodal yearly cycles, with two distinct periods of leaf coverage increase and decrease.
Thus, their phenological year may have a duration of half a calendar year.
In this study, individual trees are distinct exposed tree crowns that are observed from drone imagery.
The observations are made at partially regular intervals, and all trees are observed at the same time.
The full span of the observations ranges from  April 4, 2018 to March 18, 2024.
Observations are made at a monthly frequency between April 2018 and January 2023 and 
weekly frequency between February 2023 and March 2024.
An exception exists between February 27, 2020 and May 27, 2020 where no observations were made due to COVID-19 lockdowns.

From here onwards, I will refer to a "deciduousness event" as the period of time in which a tree drops its leaves , stays dormant and then flushes new leaves.
A leaf drop event is defined as the period of time in which a tree drops its leaves.
A leaf flush event is defined as the period of time in which a tree flushes new leaves.
A dormancy event is defined as the period of time in which a tree has no leaves. 
All of the events have a duration in days.
Leaf drop and leaf flush events have a duration and rate of change in leaf coverage.
Dormancy events have a duration but we expect no change in leaf coverage.
Fully leafed events have a duration but we expect very little change in leaf coverage attributed to leaf exchange during the phenological year.



The main questions are:
\begin{itemize}
    \item Does phenological year has an effect on the timing of leaf deciduousness events?
    \item What is the variability associated to individual trees in the timing and duration of leaf deciduousness events?
\end{itemize}

From the stated questions, we can identify two extreme cases.
\begin{itemize}
    \item A group of trees which shows no variation in the timing of leaf deciduousness events. In other words, all trees drop and flush leaves at the same time every year.
    \item A group of trees which shows cofounded intraspecific and interspecific variation in the timing of leaf deciduousness events. In other words, trees drop and flush leaves at different times every year.
\end{itemize}

The real challenge arises from the sparse observations which may not capture the transition of leaf drop and leaf flush events.
For example, if a tree is observed with full leaf coverage on day 1 and no leaves on day 30, we do not know when the tree dropped its leaves.

Let $I$ be the set of all individual trees observed.
Let $T$ be the set of all observation dates.
The phenological year for each observation date $t \in T$ is defined as $year(t)$.
The response variable is leaf coverage $y$, which is a continuous variable ranging from 0 to 100.
All trees in $I$ are observed at all dates in $T$ and each observation has an associated leaf coverage value $y$.
For the sake of simplicity, we know that all trees are synchronous and drop their leaves at the same time every year.

Thus, we can define the problem as finding a function $f$ such that:
\begin{equation}
    y_{t, i} = f(t, i, year(t)) + \epsilon
\end{equation}

Each observation $y_{t, i}$ is either the result a human annotation of the leaf coverage observed in drone imagery or 
the result of a machine learning model prediction of leaf coverage from drone imagery.
The human annotation is assumed to be the ground truth and the ML model error is low in the extremes of the leaf coverage
 range (0 and 100) and high in the middle of the range.

\begin{equation}
    \epsilon = \epsilon_{human} + \epsilon_{model}
\end{equation}

\begin{equation}
    \epsilon_{model} =
    \begin{cases}
        3, & \text{if } 0 \geq y \leq 20 \\
        3, & \text{if } 80 \leq y \leq 100 \\
        30, & \text{if } 20 < y < 80\\
    \end{cases}
\end{equation}

The $y_{t, i}$ observations are roughly 80\% human annotations and 20\% ML model predictions.

\subsection{Simulation Example 1. Synchronous Trees}
Here I simulate the values of $y_{t, i}$ for a set of 20 trees observed at the dates in $T$.

\begin{figure}
    \centering
    \includegraphics[width=\textwidth]{C:/Users/Vicente/repo/ForestLandscapes/plots/simulated_synchronous.png}
    \caption{Simulated leaf coverage observations for 20 trees observed at the dates in $T$. The black line represents the true leaf coverage curve. The points represent the observations $y_{t, i}$ for each tree $i$ at each date $t$.}
    \label{fig:interpolation_problem}
\end{figure}

We can read in the data in R. First obtain the day of year and year from the date.
Then normalize the observed leaf coverage to be between 0 and 1, avoiding exact 0 and 1 values for numerical stability.

\begin{verbatim}
    simulated<- read.csv("timeseries\\simulated_phenophase_data.csv")
    simulated$day<- yday(simulated$date)
    simulated$year<- year(simulated$date)
    simulated$y_norm <- pmin(pmax(simulated$observed_leafing / 100, 1e-4), 1 - 1e-4)
\end{verbatim}

Then we can model the data using brms with a non-linear model smoothed cyclical splines basis to campture the seasonal pattern.
Even if we have completely missed the transition of leaf drop and leaf flush events in most years.
The weekly data from 2023 and 2024 should help to constrain the model.

\begin{verbatim}
    library(brms)
    fit_smooth <- brm(
    y_norm ~ s(day,k=20, bs="cc"),
    data = simulated,
    family = Beta(),
    chains = 4,
    iter = 4000,
    warmup = 1000,
    cores = 4
    )
    >Smoothing Spline Hyperparameters:
                Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
    sds(sday_1)     2.09      0.37     1.50     2.94 1.00      980     1781
    Regression Coefficients:
            Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
    Intercept     3.34      0.03     3.28     3.39 1.00     7197     7634
    Further Distributional Parameters:
        Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
    phi    37.37      1.57    34.36    40.50 1.00     7242     7541
\end{verbatim}

By defining the start of leaf drop event as the first day in which the predicted leaf coverage is below 0.9.
We can then extract the predicted values and find the first day below 0.9.
Similarly, we can find the start of leaf flush event as the first day in which the predicted leaf coverage is above 0.9.

\begin{verbatim}
    newdata <- data.frame(day = 1:365)
    pred_draws <- posterior_epred(fit_smooth, newdata = newdata)
    pred_mean <- posterior_epred(fit_smooth, newdata = newdata, re_formula= NA)
    pred_mean <- colMeans(pred_mean)
    first_below_09 <- which(pred_mean < 0.9)[1]
    first_above_09 <- which(pred_mean > 0.9 & (1:365) > first_below_09)[1]
    ggplot(newdata, aes(x = day, y = pred_mean)) +
    geom_line(color = "blue", size = 1) +
    geom_point(data = simulated, aes(x = day, y = y_norm, color = as.factor(year)), alpha = 0.5) +
    geom_line(data = df_true, aes(x = time, y = leafing / 100), color = "red", size = 1, linetype = "dashed") +
    geom_vline(xintercept = first_below_09, color = "black", size= 1) +
    geom_vline(xintercept = first_above_09,  color = "black", size= 1) +
    labs(x = "Day of Year", y = "Predicted y_norm") +
    theme_minimal() +
    xlim(1, 60)
\end{verbatim}
We have nailed the true timing of leaf drop and leaf flush events despite the sparse observations.
Given that we have pooled all trees together and assumed they are synchronous.
\begin{figure}
    \centering
    \includegraphics[width=0.8\textwidth, height=0.4\textheight, keepaspectratio]{C:/Users/Vicente/repo/ForestLandscapes/plots/simulated_smooth.png}
    \caption{Predicted leaf coverage curve from the brms model. The black vertical lines represent the start of leaf drop and end of leaf flush events. The red dashed line represents the true leaf coverage curve. The blue line represents the predicted leaf coverage curve from the brms model. The points represent the observations $y_{t, i}$ for each tree $i$ at each date $t$.}
    \label{fig:interpolation_problem_fit}
\end{figure}

\subsection{Simulation Example 2. Asynchronous Year}
Here I simulate the values of $y_{t, i}$ for a set of 20 trees observed at the dates in $T$.
2021 is a year in which all trees drop and flush leaves at the same time but 10 days after the usual time in other years.

\begin{figure}
    \centering
    \includegraphics[width=\textwidth]{C:/Users/Vicente/repo/ForestLandscapes/plots/simulated_2021_shifted.png}
    \caption{Simulated leaf coverage observations for 20 trees observed at the dates in $T$. The solid lines represent the true leaf coverage for synchronous trees and the points represent the observations $y_{t, i}$ for each tree $i$ at each date $t$. Notice that 2021 true line is shifted 10 days forward in time.}
    \label{fig:interpolation_problem_asynchronous}
\end{figure}

This time a smoothing spline will not work with a random effect of year. 
It would only allow for vertical shifts but not horizontal shifts.
Thus we turn to model each $y_{t, i}$ as a double logistic function.
Two components are needed to capture the leaf drop and leaf flush events.
First a decay function can be defined as:
\begin{equation}
    f_{decay}(DOY)= \frac{1}{1 + e^{k_{d}(DOY - t_{d})}}
\end{equation}

Where $DOY$ is the day of year, $k_{d}$ is the rate of change of leaf drop event and $t_{d}$ is the inflection point of the leaf drop event.
Here $LC \approx 1$ when $DOY << t_{d}$ and $LC \approx 0$ when $DOY >> t_{d}$.

Similarly, a leaf flush function can be defined as:
\begin{equation}
    f_{flush}(DOY)= \frac{1}{1 + e^{-k_{f}(DOY - t_{f})}}
\end{equation}
Where $k_{f}$ is the rate of change of leaf flush event and $t_{f}$ is the inflection point of the leaf flush event.
Notice the negative sign in the exponent which makes $LC \approx 0$ when $DOY << t_{f}$ and $LC \approx 1$ when $DOY >> t_{f}$.


In r we can write the functions as:

\begin{verbatim}
    f_decay <- function(day, k_d, t_d) {
      1 / (1 + exp(k_d * (day - t_d)))
    }

    f_flush <- function(day, k_f, t_f) {
      1 / (1 + exp(-k_f * (day - t_f)))
    }
\end{verbatim}

We can evaluate each function separately and plot them. For the rate of decay we can concibe $K_d = K_f = 0.8$  which means a loss
of 0.8 units of leaf coverage per day at the inflection point. For the timing of the events we can concieve $t_d = 20$ and $t_f = 50$.
\begin{verbatim}
    values <- seq(1, 70, by = 1)
    decay_values <- f_decay(values, k_d = 0.8, t_d = 20)
    flush_values <- f_flush(values, k_f = 0.8, t_f = 50)

    plot(values, decay_values, type='l', col='blue', ylim=c(0,1))
    lines(values, flush_values, col='red') 
\end{verbatim}
\begin{figure}
    \centering
    \includegraphics[width=0.8\textwidth, height=0.4\textheight, keepaspectratio]{C:/Users/Vicente/repo/ForestLandscapes/plots/decay_flush.png}
    \caption{Decay function in blue and flush function in red. The product of both functions gives the leaf coverage curve.}
    \label{fig:double_logistic_functions}
\end{figure}

To relate both functions to leaf coverage neither the product or sum of both functions work.
We turn to an intermidiate phase function which makes the decay or flush function when relevant. 
\begin{equation}
    f_{phase}(DOY)= \frac{1}{1 + e^{-0.5 (DOY - t_m)}}
\end{equation}
Where $t_m$ is the midpoint between $t_d$ and $t_f$.
A simplified formula for the double logistic function of leaf coverage is:
\begin{equation}
    LC(DOY)= f_{decay}(DOY) * f_{phase}(DOY) + f_{flush}(DOY) * (1 - f_{phase}(DOY))
\end{equation}
A full form of the double logistic function of leaf coverage is:
\begin{equation}
    LC(DOY)= \frac{1}{1 + e^{k_{d}(DOY - t_{d})}} * \frac{1}{1 + e^{-0.5 (DOY - t_m)}} + \frac{1}{1 + e^{-k_{f}(DOY - t_{f})}} * \left(1 - \frac{1}{1 + e^{-0.5 (DOY - t_m)}}\right)
\end{equation}

In R we can write the phase function and the full double logistic function as:
\begin{verbatim}
    f_phase <- function(values, tm){
    1/ (1 + exp(-0.5 * (values - tm)))   
    }
    LC<- function(values, k_d, t_d, k_f, t_f){
        t_m<- (t_d + t_f) / 2
        values<- (1-f_phase(values, t_m)) * f_decay(values, k_d, t_d) + f_phase(values, t_m) * f_flush(values, k_f, t_f)
        return(values)
    }
    LC_values<- LC(values, k_d=0.8, t_d=20, k_f=0.8, t_f=50)
    plot(values, LC_values, type='l', col='black', ylim=c(0,1))
\end{verbatim}


\begin{figure}
    \centering
    \includegraphics[width=0.8\textwidth, height=0.4\textheight, keepaspectratio]{C:/Users/Vicente/repo/ForestLandscapes/plots/doubleLogistic_phased.png}
    \caption{Double logistic function of leaf coverage in black. The parameters used were $k_d = k_f = 0.8$, $t_d = 20$ and $t_f = 50$.}
    \label{fig:double_logistic_leaf_coverage}
\end{figure}

So, let's write it up in brms.

\begin{verbatim}
    form <- bf(
    y_norm ~ (1 - ( 1 / (1 + exp(-0.5 * (day - (td + tf)/2))))) *
    ( 1 / (1 + exp(kd * (day - td)))) +
    (1 / (1 + exp(-0.5 * (day - (td + tf)/2)))) *
    (1 / (1 + exp(-kf * (day - tf)))),
    kd + kf + td + tf ~ 1 + (1 | year),
    nl = TRUE)

    priors <- c(
    prior(normal(25, 2), nlpar = "td"),  # ~95% in [10, 40]
    prior(normal(50, 2), nlpar = "tf"),    # ~95% in [30, 70]
    prior(normal(0.8, 0.2), nlpar = "kd"),
    prior(normal(0.8, 0.2), nlpar = "kf")
    )

    doubleLogisticPhased<- brm(
        form,
        data = simulated,
        family = Beta(),
        prior = priors,
        control = list(adapt_delta = 0.95, max_treedepth = 15),
        iter= 4000,
        warmup= 2000,
        chains= 4,
        cores= 4
    )
\end{verbatim}


After some data frame wrangling we can plot the posterior distribution of the parameter
for $t_d$ which in this case signifies the inflection point of the leaf drop event.

\begin{figure}
    \centering
    \includegraphics[width=0.8\textwidth, height=0.4\textheight, keepaspectratio]{C:/Users/Vicente/repo/ForestLandscapes/plots/td_posterior.png}
    \caption{Posterior distribution of the parameter $t_d$ for each year. Notice that 2021 has a posterior distribution shifted to the right, indicating a later leaf drop event.}
    \label{fig:td_posterior}
\end{figure}

We can test a hypothesis by taking the difference of the posterior distributions of $t_d$ for 2021 and all other years.
\begin{verbatim}
    td_long_2021<- td_long %>% filter(year=="2021")
    td_long_not_2021<- td_long %>% filter(year!="2021")
    years_others<- unique(td_long_not_2021$year)

    for (i in 1:length(years_others)) {
        ref_values <- td_long_not_2021 %>% filter(year == years_others[i]) %>% pull(td)
        diff<- td_long_2021$td - ref_values
        print(paste("Pr(td2021 > td", years_others[i], ") =", round(mean(diff > 0), 3)))
        print(quantile(diff, probs=c(0.025, 0.5, 0.975)))
    }
    [1] "Pr(td2021 > td 2018 ) = 0.641"
        2.5%        50%      97.5%
    -7.3418307  0.7626829 23.7579312
    [1] "Pr(td2021 > td 2019 ) = 0.746"
        2.5%       50%     97.5%
    -4.245506  2.748767 29.318359
    [1] "Pr(td2021 > td 2020 ) = 0.747"
        2.5%       50%     97.5%
    -4.287576  2.637999 29.643458
    [1] "Pr(td2021 > td 2022 ) = 0.706"
        2.5%       50%     97.5%
    -3.529688  2.654654 28.601176
    [1] "Pr(td2021 > td 2023 ) = 0.663"
        2.5%       50%     97.5%
    -4.309944  1.924723 27.771528
    [1] "Pr(td2021 > td 2024 ) = 0.636"
        2.5%       50%     97.5%
    -5.085629  1.321426 19.839795
\end{verbatim}

The closest difference is between 2021 and 2020 which indicates a 74.7\% probability that $t_d$ in 2021 is greater than $t_d$ in 2020. 
The median difference is 2.64 days and the 95\% credible interval is [-4.29, 29.64]. which is plausible given the sparse observations.

\subsection{Simulation Example 3. Asynchronous Trees}

All trees are synchronous with the exception of tree E which drops its leaves 5 days later than the rest of the trees every year.
All trees drop their leaves at the same time every year, with the exception of year 2021 in which all trees drop their leaves 10 days later than usual.
Thus tree E drops its leaves 15 days later than the rest of the trees in 2021.

\begin{figure}
    \centering
    \includegraphics[width=\textwidth]{C:/Users/Vicente/repo/ForestLandscapes/plots/simulation_intra.png}
    \caption{Simulated leaf coverage observations for 20 trees observed at the dates in $T$. The solid purple line represents the true leafing for tree E, light blue represents the true leafing for all other trees.}
    \label{fig:interpolation_problem_asynchronous_trees}
\end{figure}

For this case we can modify the previous model to include a random effect of individual tree in all the parameters.

\begin{verbatim}
    form <- bf(
    y_norm ~ (1 - ( 1 / (1 + exp(-0.5 * (day - (td + tf)/2))))) *
    ( 1 / (1 + exp(kd * (day - td)))) +
    (1 / (1 + exp(-0.5 * (day - (td + tf)/2)))) *
    (1 / (1 + exp(-kf * (day - tf)))),
    kd + kf + td + tf ~ 1 + (1 | year) + (1 | tree),
    nl = TRUE)

    priors <- c(
    prior(normal(25, 2), nlpar = "td"), 
    prior(normal(50, 2), nlpar = "tf"),    
    prior(normal(0.8, 0.2), nlpar = "kd"),
    prior(normal(0.8, 0.2), nlpar = "kf")
    )
    doubleLogisticPhased_intra<- brm(
        form,
        data = simulated,
        family = Beta(),
        prior = priors,
        control = list(adapt_delta = 0.95, max_treedepth = 15),
        iter= 4000,
        warmup= 2000,
        chains= 4,
        cores= 4
    )
\end{verbatim}

\begin{figure}
    \centering
    \includegraphics[width=0.8\textwidth, height=0.4\textheight, keepaspectratio]{C:/Users/Vicente/repo/ForestLandscapes/plots/asynchronous_td_bimodal.png}
    \caption{Posterior distribution of the parameter $t_d$ for each year.}
    \label{fig:td_posterior_intra}
\end{figure}

The model detects two peaks in the posterior distribution of $t_d$ for the year 2021.
One mode corresponds to the actual simulated value of +30 DOY and the other mode corresponds to the usual value of +20 DOY.
This demostrates that the model has not rejected the possibility of year 2021 being synchronous.
Notice year 2024 having narrower posterior distribution due to the weekly observations.
This demostrates we are more certain about the timing of leaf drop event in years with more frequent observations.

\begin{figure}
    \centering
    \includegraphics[width=0.8\textwidth, height=0.4\textheight, keepaspectratio]{C:/Users/Vicente/repo/ForestLandscapes/plots/asynchronous_td_tree.png}
    \caption{Posterior distribution of the parameter $t_d$ for trees.}
    \label{fig:td_posterior_treeE}
\end{figure}

The model does not detect a difference in the posterior distribution of $t_d$ for tree E.
One possible reason for this is that a 5 day difference is too small to be detected given the sparse observations.
Another possible reason is that the model is giving a each tree an intercept and each year an intercept but not allowing for interaction between tree and year.

We will evaluate this by creating a new model with an interaction between tree and year in the parameter $t_d$.

\begin{verbatim}
    form <- bf(
    y_norm ~ (1 - ( 1 / (1 + exp(-0.5 * (day - (td + tf)/2))))) *
     ( 1 / (1 + exp(kd * (day - td)))) +
     (1 / (1 + exp(-0.5 * (day - (td + tf)/2)))) *
     (1 / (1 + exp(-kf * (day - tf)))),
     kd + kf + td + tf ~ 1 + (1 | treeYear) ,
     nl = TRUE)

    simulated<- read.csv("timeseries\\simulated_phenophase_data.csv")
    simulated<- simulated %>%
        mutate(day= yday(date),
                year= year(date),
                y_norm = pmin(pmax(observed_leafing / 100, 1e-4), 1 - 1e-4),
                treeYear= paste(tree, year, sep="_"))
    doubleLogisticPhased<- brm(
    form,
    data = simulated,
    family = Beta(),
    prior = priors,
    control = list(adapt_delta = 0.95, max_treedepth = 15),
    iter= 4000,
    warmup= 2000,
    chains= 4,
    cores= 4

    post<- as_draws_df(doubleLogisticPhased)
    colnames_post<- colnames(post)
    post_td<- post[,grep("td", colnames_post)]
    post_td_2021_long<- as.data.frame(post_td) %>%
    pivot_longer(
        cols= everything(),
        names_to= "td_name",
        values_to= "td"
    ) %>% 
    mutate(tree= gsub("r_treeYear__td\\[([A-Z])_.*", "\\1", td_name),
            year= gsub("r_treeYear__td\\[[A-Z]_(\\d{4}),.*", "\\1", td_name))%>%
        filter(year %in% c(2018,2019,2020,2021,2022,2023,2024))

    ggplot(post_td_2021_long, aes(x=td, fill=year))+
    geom_histogram(bins=200)+
    facet_wrap(~tree, ncol=1, scales = "fixed")+
        xlim(-5,5)+
        theme(strip.text = element_blank())
)
\end{verbatim}

\begin{figure}
    \centering
    \includegraphics[width=0.8\textwidth, height=0.4\textheight, keepaspectratio]{C:/Users/Vicente/repo/ForestLandscapes/plots/interaction_model.png}
    \caption{Posterior distribution of the parameter $t_d$ for trees and years. Years are stacked and each tree is a separate facet.}
    \label{fig:td_posterior_treeE_year}
\end{figure}

No difference between years or trees is detected. We might getting spreaded too thin with the interaction, 20 trees, 7 years gives us 140 levels of the random effect. Each group has 4 parameters to estimate, $k_d$, $k_f$, $t_d$ and $t_f$.
This gives us a total of 560 parameters to estimate.
This is probably too much for the data we have.
Let's try a different model where we fit a fixed effect for year to effectively give each year its own curve and a random effect for tree to give each tree its own intercept.


This one time we simulate the $t_d$ parameter for tree E to be at DOY 48 in all years except in 2021 where it is at DOY 58.
All other trees have $t_d$ at DOY 43 and 10 days later in 2021 at DOY 53.

\begin{verbatim}
    
form <- bf(
    y_norm ~ (1 - ( 1 / (1 + exp(-0.5 * (day - (td + tf)/2))))) *
    ( 1 / (1 + exp(kd * (day - td)))) + (1 / (1 + exp(-0.5 *
    (day - (td + tf)/2)))) * (1 / (1 + exp(-kf * (day - tf)))),
    kd + kf + td + tf ~ year + (1 | tree),
    nl = TRUE)

    priors <- c(
    prior(normal(42, 3), nlpar = "td"),  
    prior(normal(62, 3), nlpar = "tf"),    
    prior(normal(0.8, 0.2), nlpar = "kd"),
    prior(normal(0.8, 0.2), nlpar = "kf")
    )

    doubleLogisticPhased<- brm(
    form,
    data = simulated,
    family = Beta(),
    prior = priors,
    control = list(adapt_delta = 0.95, max_treedepth = 15),
    iter= 4000,
    warmup= 2000,
    chains= 4,
    cores= 4
    )
\end{verbatim}

We have dropped the year 2018 since it has no observations during the leaf drop event.

\begin{figure}
    \centering
    \includegraphics[width=0.8\textwidth, height=0.4\textheight, keepaspectratio]{C:/Users/Vicente/repo/ForestLandscapes/plots/fixeradnomdouble.png}
    \caption{Posterior distribution of the parameter $t_d$ for each year.}
    \label{fig:td_posterior_treeE_year_fixed}
\end{figure}

The Intercept year corresponds to 2019 a its estimate is around 18 DOY which is 25 days before the actual simulated value of 43 DOY.
all other years roughly approximate the simulated value of 43, and 2021 does not show a shift in time. 
\begin{verbatim}
    Yearly Effects:
                  Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
    td_Intercept    18.53     10.35     9.81    40.38 1.54        7       33
    td_year2020     40.60      2.34    35.95    45.41 1.06       59       94
    td_year2021     40.07      2.39    35.57    44.89 1.09       35       66
    td_year2022     39.02      2.35    34.28    44.19 1.13       22       43
    td_year2023     33.40      4.17    28.24    42.61 1.53        7       37
    td_year2024     33.72      4.04    28.63    42.95 1.53        7       37
\end{verbatim}

Now examine the random effect of tree.
No shift was detected for tree E.
\begin{figure}
    \centering
    \includegraphics[width=0.8\textwidth, height=0.4\textheight, keepaspectratio]{C:/Users/Vicente/repo/ForestLandscapes/plots/randomdoubled.png}
    \caption{Posterior distribution of the parameter $t_d$ for trees.}
    \label{fig:td_posterior_tree_fixed}
\end{figure}



\begin{equation}
    LC~(DOY)= (1 - \frac{1}{(1 + e^{-0.5 (DOY - (t_{d} + \delta/2))})}) *
    \frac{1}{(1 + e^{k_{d}(DOY - t_{d})})} +
    \frac{1}{(1 + e^{-0.5 (DOY - (t_{d} + \delta/2))})} *
    \frac{1}{(1 + e^{-k_{f}(DOY - (t_{d} + \delta))})}
\end{equation}

\begin{equation}
    t_{f}= t_{d} + \delta
    t_{m}= t_{d} + \delta/2
\end{equation}

\section{Next Steps}

We must evaluate if the parameters are estimable given the following simplified model for leaf drop event only.
\begin{equation}
    LC(DOY)= \frac{1}{1 + e^{k_{d}(DOY - t_{d})}}
\end{equation}
The will fit a bayesian non-linear model with global intercept for $k_d$. 
And random effects for tree and year in $t_d$.
\begin{equation}
    t_{d} ~ 1 + (1 | tree) + (1 | year)
\end{equation}

Implement Data cloning from Lele et al. 2007 to evaluate parameter estimability.

\end{document}
